<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>余数射手</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f8ff;
            margin: 0;
            padding: 20px;
            user-select: none;
            overflow: hidden;
        }
        
        #gameTitle {
            font-size: 36px;
            color: #ff6b6b;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        #gameRules {
            font-size: 16px;
            color: #333;
            margin-bottom: 30px;
            background-color: #e6f7ff;
            padding: 10px;
            border-radius: 10px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        #gameContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70vh;
            position: relative;
        }
        
        .area-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .area-label {
            font-size: 20px;
            font-weight: bold;
            margin-right: 20px;
            width: 100px;
            text-align: right;
        }
        
        #monsterArea {
            height: 100px;
            width: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        #monster {
            font-size: 48px;
            font-weight: bold;
            color: #ff0000;
            background-color: #fff;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
            transition: all 0.3s;
        }
        
        #ballsArea {
            height: 200px;
            width: 500px;
            position: relative;
            margin-bottom: 20px;
            background-color: #f5f5f5;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .ball {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #4caf50;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: grab;
            position: absolute;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            z-index: 5;
        }
        
        .ball:active {
            cursor: grabbing;
        }
        
        #cannonArea {
            height: 100px;
            width: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        #cannon {
            font-size: 36px;
            font-weight: bold;
            color: white;
            background-color: #2196f3;
            border-radius: 10px;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        
        #scoreArea {
            font-size: 24px;
            margin-top: 20px;
            color: #333;
        }
        
        #timerArea {
            font-size: 24px;
            margin-top: 10px;
            color: #333;
        }
        
        #gameOver {
            font-size: 36px;
            color: #ff0000;
            margin-top: 20px;
            display: none;
        }
        
        #finalScore {
            font-size: 28px;
            margin-top: 10px;
            display: none;
            color: #ff6b6b; /* 添加颜色样式 */
            font-weight: bold; /* 添加加粗样式 */
        }
        
        #restartButton {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 18px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }
        
        #restartButton:hover {
            background-color: #45a049;
        }
        
        .projectile {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #4caf50;
            position: absolute;
            z-index: 8;
        }
        
        .explosion {
            position: absolute;
            width: 80px;
            height: 80px;
            background-image: radial-gradient(circle, #ffcc00, #ff6600, transparent 70%);
            border-radius: 50%;
            opacity: 0;
            z-index: 9;
            pointer-events: none;
        }
        
        #missText {
            position: absolute;
            font-size: 24px;
            color: #ff0000;
            font-weight: bold;
            z-index: 11;
            opacity: 0;
            transition: all 0.5s;
            pointer-events: none;
        }
        
        #penaltyText {
            position: absolute;
            font-size: 24px;
            color: #ff0000;
            font-weight: bold;
            z-index: 11;
            opacity: 0;
            transition: all 0.5s;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h1 id="gameTitle">余数射手</h1>
    <div id="gameRules">
        游戏规则：
        1.拖动绿色彩球到炮台，若绿色彩球上的数字÷炮台上的数字，余数刚好是红色彩球上的数字，则击中得1分。
        2.连续两次未击中数字怪兽，得分减1分。
        3.限时3分钟，得分多的胜。
    </div>
    
    <div id="gameContainer">
        <div class="area-container">
            <div class="area-label" style="color: #ff0000;">数字怪兽</div>
            <div id="missText">未击中!</div>
            <div id="penaltyText">扣分!</div>
            <div id="monsterArea">
                <div id="monster">?</div>
            </div>
        </div>
        
        <div id="ballsArea">
            <!-- 彩球将通过JavaScript动态生成 -->
        </div>
        
        <div class="area-container">
            <div class="area-label" style="color: #2196f3;">蓝色炮台</div>
            <div id="cannonArea">
                <div id="cannon">?</div>
            </div>
        </div>
    </div>
    
    <div id="scoreArea">得分: <span id="score">0</span></div>
    <div id="timerArea">时间: <span id="timer">180</span>秒</div>
    <div id="gameOver">游戏结束!</div>
    <div id="finalScore">最终得分: <span id="finalScoreValue">0</span></div>
    <button id="restartButton">重新开始</button>
    
    <audio id="shootSound" src="https://www.soundjay.com/buttons/sounds/button-09.mp3" preload="auto"></audio>
    <audio id="hitSound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>
    <audio id="missSound" src="https://www.soundjay.com/buttons/sounds/button-11.mp3" preload="auto"></audio>
    <audio id="explosionSound" src="https://www.soundjay.com/mechanical/sounds/explosion-01.mp3" preload="auto"></audio>
    <audio id="penaltySound" src="https://www.soundjay.com/button/beep-07.wav" preload="auto"></audio>
    
    <script>
        // 游戏变量
        let score = 0;
        let timeLeft = 180; // 3分钟 = 180秒
        let gameActive = true;
        let monsterNumber = 0;
        let cannonNumber = 0;
        let balls = [];
        let timerInterval;
        let consecutiveMisses = 0; // 新增：连续未击中次数
        
        // DOM元素
        const scoreElement = document.getElementById('score');
        const timerElement = document.getElementById('timer');
        const monsterElement = document.getElementById('monster');
        const cannonElement = document.getElementById('cannon');
        const ballsArea = document.getElementById('ballsArea');
        const gameOverElement = document.getElementById('gameOver');
        const finalScoreElement = document.getElementById('finalScore');
        const finalScoreValueElement = document.getElementById('finalScoreValue');
        const restartButton = document.getElementById('restartButton');
        const shootSound = document.getElementById('shootSound');
        const hitSound = document.getElementById('hitSound');
        const missSound = document.getElementById('missSound');
        const explosionSound = document.getElementById('explosionSound');
        const penaltySound = document.getElementById('penaltySound'); // 新增：扣分音效
        const gameContainer = document.getElementById('gameContainer');
        const missText = document.getElementById('missText');
        const penaltyText = document.getElementById('penaltyText'); // 新增：扣分提示
        
        // 初始化游戏
        function initGame() {
            score = 0;
            timeLeft = 180;
            gameActive = true;
            consecutiveMisses = 0; // 重置连续未击中次数
            scoreElement.textContent = score;
            timerElement.textContent = timeLeft;
            gameOverElement.style.display = 'none';
            finalScoreElement.style.display = 'none';
            restartButton.style.display = 'none';
            missText.style.opacity = '0';
            penaltyText.style.opacity = '0';
            
            // 清空彩球区域
            ballsArea.innerHTML = '';
            balls = [];
            
            // 生成炮台数字 (1-9)
            cannonNumber = Math.floor(Math.random() * 9) + 1; // 1-9
            cannonElement.textContent = cannonNumber;
            
            // 生成数字怪兽 (1 < x < 炮台数字)
            generateMonster();
            
            // 生成5个彩球
            generateBalls();
            
            // 启动计时器
            startTimer();
        }
        
        // 生成数字怪兽 (确保小于炮台数字)
        function generateMonster() {
            if (cannonNumber <= 2) {
                // 如果炮台数字是1或2，怪兽只能是1（但根据规则应该大于1）
                // 所以这里调整为炮台至少为2，怪兽为1
                // 但根据游戏规则，怪兽数字应该大于1
                // 所以我们需要确保炮台数字至少比怪兽大1
                cannonNumber = Math.max(2, cannonNumber);
                cannonElement.textContent = cannonNumber;
                monsterNumber = 1;
            } else {
                monsterNumber = Math.floor(Math.random() * (cannonNumber - 1)) + 1; // 1到cannonNumber-1
            }
            
            // 确保怪兽数字大于1
            if (monsterNumber < 2) {
                monsterNumber = 2;
                // 如果炮台数字不大于怪兽数字，增加炮台数字
                if (cannonNumber <= monsterNumber) {
                    cannonNumber = monsterNumber + 1;
                    cannonElement.textContent = cannonNumber;
                }
            }
            
            monsterElement.textContent = monsterNumber;
            monsterElement.style.transform = 'scale(1)';
            monsterElement.style.opacity = '1';
        }
        
        // 生成彩球
        function generateBalls() {
            // 先清空现有球
            ballsArea.innerHTML = '';
            balls = [];
            
            // 生成5个球的位置
            const positions = [];
            const maxX = ballsArea.clientWidth - 50;
            const maxY = ballsArea.clientHeight - 50;
            
            for (let i = 0; i < 5; i++) {
                let x, y, overlapping;
                let attempts = 0;
                
                // 尝试找到一个不重叠的位置
                do {
                    overlapping = false;
                    x = Math.floor(Math.random() * maxX);
                    y = Math.floor(Math.random() * maxY);
                    
                    // 检查是否与其他球重叠
                    for (const pos of positions) {
                        const dx = pos.x - x;
                        const dy = pos.y - y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 60) { // 60是球直径+安全距离
                            overlapping = true;
                            break;
                        }
                    }
                    
                    attempts++;
                    if (attempts > 100) break; // 防止无限循环
                } while (overlapping);
                
                positions.push({ x, y });
                
                // 创建球元素
                const ball = document.createElement('div');
                ball.className = 'ball';
                ball.id = 'ball' + i;
                ball.style.left = x + 'px';
                ball.style.top = y + 'px';
                
                // 生成球上的数字
                let ballNumber;
                if (i < 4) {
                    ballNumber = Math.floor(Math.random() * 98) + 2; // 2-99
                } else {
                    const multiple = Math.floor(Math.random() * 10) + 1; // 1-10
                    ballNumber = cannonNumber * multiple + monsterNumber;
                }
                
                ball.textContent = ballNumber;
                balls.push({ element: ball, number: ballNumber, originalNumber: ballNumber });
                
                // 添加拖拽事件
                ball.draggable = true;
                ball.addEventListener('dragstart', dragStart);
                
                ballsArea.appendChild(ball);
            }
        }
        
        // 拖拽开始
        function dragStart(e) {
            if (!gameActive) {
                e.preventDefault();
                return;
            }
            
            e.dataTransfer.setData('text/plain', e.target.id);
        }
        
        // 炮台设置为拖放目标
        cannonElement.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        cannonElement.addEventListener('drop', function(e) {
            if (!gameActive) return;
            
            e.preventDefault();
            const ballId = e.dataTransfer.getData('text/plain');
            const ballElement = document.getElementById(ballId);
            
            if (ballElement) {
                // 播放射击音效
                shootSound.currentTime = 0;
                shootSound.play();
                
                // 找到对应的球数据
                const ballData = balls.find(b => b.element.id === ballId);
                if (ballData) {
                    const ballNumber = ballData.number;
                    const remainder = ballNumber % cannonNumber;
                    
                    // 创建发射的弹丸
                    const projectile = document.createElement('div');
                    projectile.className = 'projectile';
                    
                    // 获取炮台和球的位置
                    const cannonRect = cannonElement.getBoundingClientRect();
                    const ballRect = ballElement.getBoundingClientRect();
                    const containerRect = gameContainer.getBoundingClientRect();
                    
                    // 设置弹丸初始位置
                    const startX = cannonRect.left - containerRect.left + cannonRect.width / 2 - 10;
                    const startY = cannonRect.top - containerRect.top + cannonRect.height / 2 - 10;
                    
                    projectile.style.left = startX + 'px';
                    projectile.style.top = startY + 'px';
                    
                    gameContainer.appendChild(projectile);
                    
                    // 获取怪兽位置
                    const monsterRect = monsterElement.getBoundingClientRect();
                    const targetX = monsterRect.left - containerRect.left + monsterRect.width / 2 - 10;
                    const targetY = monsterRect.top - containerRect.top + monsterRect.height / 2 - 10;
                    
                    // 动画：弹丸飞向怪兽
                    const duration = 500; // 动画持续时间(毫秒)
                    const startTime = performance.now();
                    
                    function animateProjectile(currentTime) {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        // 计算当前位置
                        const currentX = startX + (targetX - startX) * progress;
                        const currentY = startY + (targetY - startY) * progress;
                        
                        projectile.style.left = currentX + 'px';
                        projectile.style.top = currentY + 'px';
                        
                        if (progress < 1) {
                            requestAnimationFrame(animateProjectile);
                        } else {
                            // 动画结束
                            gameContainer.removeChild(projectile);
                            
                            // 检查是否击中
                            if (remainder === monsterNumber) {
                                // 击中
                                hitSound.currentTime = 0;
                                hitSound.play();
                                
                                // 创建爆炸效果
                                const explosion = document.createElement('div');
                                explosion.className = 'explosion';
                                explosion.style.left = (targetX - 40) + 'px';
                                explosion.style.top = (targetY - 40) + 'px';
                                gameContainer.appendChild(explosion);
                                
                                // 播放爆炸音效
                                explosionSound.currentTime = 0;
                                explosionSound.play();
                                
                                // 爆炸动画
                                let opacity = 1;
                                let scale = 0.5;
                                const explosionInterval = setInterval(() => {
                                    opacity -= 0.05;
                                    scale += 0.05;
                                    explosion.style.opacity = opacity;
                                    explosion.style.transform = `scale(${scale})`;
                                    
                                    if (opacity <= 0) {
                                        clearInterval(explosionInterval);
                                        gameContainer.removeChild(explosion);
                                    }
                                }, 30);
                                
                                score++;
                                scoreElement.textContent = score;
                                consecutiveMisses = 0; // 重置连续未击中次数
                                
                                // 怪兽消失效果
                                monsterElement.style.transform = 'scale(1.5)';
                                monsterElement.style.opacity = '0';
                                
                                setTimeout(() => {
                                    // 生成新的炮台数字
                                    cannonNumber = Math.floor(Math.random() * 9) + 1; // 1-9
                                    cannonElement.textContent = cannonNumber;
                                    
                                    // 生成新的怪兽和球
                                    generateMonster();
                                    generateBalls();
                                }, 500);
                            } else {
                                // 未击中
                                missSound.currentTime = 0;
                                missSound.play();
                                
                                // 显示"未击中"文字
                                missText.style.left = (targetX - 50) + 'px';
                                missText.style.top = (targetY - 20) + 'px';
                                missText.style.opacity = '1';
                                
                                setTimeout(() => {
                                    missText.style.opacity = '0';
                                }, 1000);
                                
                                // 增加连续未击中次数
                                consecutiveMisses++;
                                
                                // 检查是否连续两次未击中
                                if (consecutiveMisses >= 2) {
                                    // 扣分
                                    if (score > 0) {
                                        score--;
                                        scoreElement.textContent = score;
                                        
                                        // 播放扣分音效
                                        penaltySound.currentTime = 0;
                                        penaltySound.play();
                                        
                                        // 显示"扣分"文字
                                        penaltyText.style.left = (targetX - 30) + 'px';
                                        penaltyText.style.top = (targetY - 50) + 'px';
                                        penaltyText.style.opacity = '1';
                                        
                                        setTimeout(() => {
                                            penaltyText.style.opacity = '0';
                                        }, 1000);
                                    }
                                    
                                    consecutiveMisses = 0; // 重置连续未击中次数
                                }
                                
                                // 将球移回原位
                                const ballData = balls.find(b => b.element.id === ballId);
                                if (ballData) {
                                    ballData.element.style.left = ballData.element.dataset.originalX + 'px';
                                    ballData.element.style.top = ballData.element.dataset.originalY + 'px';
                                }
                            }
                        }
                    }
                    
                    // 保存球的原始位置
                    ballElement.dataset.originalX = ballElement.style.left;
                    ballElement.dataset.originalY = ballElement.style.top;
                    
                    requestAnimationFrame(animateProjectile);
                }
            }
        });
        
        // 计时器
        function startTimer() {
            clearInterval(timerInterval); // 清除之前的计时器
            timerInterval = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }
        
        // 游戏结束
        function endGame() {
            gameActive = false;
            gameOverElement.style.display = 'block';
            finalScoreValueElement.textContent = score;
            finalScoreElement.style.display = 'block';
            restartButton.style.display = 'inline-block';
        }
        
        // 重新开始按钮
        restartButton.addEventListener('click', initGame);
        
        // 初始化游戏
        initGame();
        
        // 窗口大小改变时重新生成球的位置
        window.addEventListener('resize', function() {
            if (gameActive) {
                generateBalls();
            }
        });
    </script>
</body>
</html>